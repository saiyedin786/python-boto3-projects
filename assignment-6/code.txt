import boto3
from datetime import datetime, timedelta

# ---------------- CONFIG ----------------
THRESHOLD = 50.0  # USD
SNS_TOPIC_ARN = "arn:aws:sns:ap-south-1:254292659362:billing-alert-topic"
# ----------------------------------------

def lambda_handler(event, context):
    # CloudWatch Billing metrics are only in us-east-1
    cloudwatch = boto3.client("cloudwatch", region_name="ap-south-1")
    sns = boto3.client("sns")

    # Time range (last 1 day)
    end_time = datetime.utcnow()
    start_time = end_time - timedelta(days=1)

    # Get billing metric
    response = cloudwatch.get_metric_statistics(
        Namespace="AWS/Billing",
        MetricName="EstimatedCharges",
        Dimensions=[
            {
                "Name": "Currency",
                "Value": "USD"
            }
        ],
        StartTime=start_time,
        EndTime=end_time,
        Period=86400,
        Statistics=["Maximum"]
    )

    if not response["Datapoints"]:
        print("No billing data available")
        return

    billing_amount = response["Datapoints"][0]["Maximum"]
    print(f"Current estimated billing: ${billing_amount}")

    # Compare with threshold
    if billing_amount > THRESHOLD:
        message = (
            f"AWS Billing Alert!\n\n"
            f"Current estimated charges: ${billing_amount}\n"
            f"Threshold: ${THRESHOLD}\n"
        )

        sns.publish(
            TopicArn=SNS_TOPIC_ARN,
            Subject="AWS Billing Alert",
            Message=message
        )

        print("Alert sent via SNS")
    else:
        print("Billing is within limit")

